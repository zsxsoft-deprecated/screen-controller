<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">
<meta name="author" content="">
<title><%= title %></title>
<link rel="stylesheet" href="/stylesheets/bootstrap.css" />
<meta charset="utf-8">
</head>
<body>
<div class="navbar navbar-default navbar-static-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
      <a class="navbar-brand" href="#"><%= title %>控制程序</a> </div>
    <div class="navbar-collapse collapse"> </div>
  </div>
</div>
<div class="container">
  <div class="jumbotron">
    <p>手动写JavaScript：
      <input type="text" class="form-control" id="text-javascript" style="width:30%;display:inline" />
      &nbsp;
      <input type="button" class="btn btn-success" value="提交" id="controlbutton-postjavascript"/>
    </p>
    <p>播放ID：<span class="dom-playing-id"></span></p>
    <p>正在播放：<span class="dom-playing-name"></span></p>
    <p>演唱者：<span class="dom-playing-player"></span></p>
    <p>音乐连接测试：<span class="dom-playing-bgmcheck">0</span></p>
    <p>快速切换节目：
      <select id="controlselect-changeprogram">
      </select>
    </p>
    <p>快速切换BGM：
      <select id="controlselect-changebgm">
      </select>
    </p>
    <p style="display:none">音乐控制台：
    <audio id="dom-audio-test" controls></audio>
    </p>
    <p> 
      <!--    <audio id="_audio" style="width:100%" controls></audio>--> 
    </p>
    <p>
      <input type="button" class="btn btn-info" value="播放" id="controlbutton-play"/>
      &nbsp;
      <input type="button" class="btn btn-warning" value="暂停" id="controlbutton-pause"/>
      &nbsp;
      <input type="button" class="btn btn-danger" value="停止" id="controlbutton-stop"/>
    </p>
    <p>
      <input type="button" class="btn btn-default" value="上一个节目" id="controlbutton-prev"/>
      &nbsp;
      <input type="button" class="btn btn-success" value="下一个节目" id="controlbutton-next" />
    </p>
    <p>
      <input type="button" class="btn btn-toolbar" value="背景向前切换" id="controlbutton-toggle-background-prev"/>
      &nbsp;
      <input type="button" class="btn btn-toolbar" value="背景向后切换" id="controlbutton-toggle-background-next"/>
      &nbsp;
      （自动切换：<span class="dom-autoplay"></span>）
    </p>
    <p>
      <input type="button" class="btn btn-toolbar" value="音乐向前切换" id="controlbutton-toggle-music-prev"/>
      &nbsp;
      <input type="button" class="btn btn-toolbar" value="音乐向后切换" id="controlbutton-toggle-music-next"/>
    </p>
    <p>
      <input type="button" class="btn btn-link" value="背景模式" id="controlbutton-background"/>
      &nbsp;
      <input type="button" class="btn btn-link" value="计分模式" id="controlbutton-score"/>
      &nbsp;
      <input type="button" class="btn btn-link" value="初始化数据" id="controlbutton-init"/>
      &nbsp; 
      <!--<input type="button" class="btn btn-link" value="时间校正" onclick="if(!sendingcur)try{audio.currentTime = parseFloat($('#latestlog').html().split('\n')[0]);}catch(e){} "/>--> 
    </p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <p>&nbsp;</p>
    <div id="latestlog"> </div>
    <p></p>
  </div>
</div>
<script src="/socket.io/socket.io.js"></script> 
<script src="/js/jquery-2.0.3.min.js"></script> 
<script src="/js/bootstrap.min.js"></script> 
<script src="/js/holder.min.js"></script> 
<script src="/js/global.js"></script> 
<script>
"use stricts";
var IN_SCREEN = false;

var queue = {"data": [], "callback": []}, queue_max = 0;
var programs = null, program = null, program_id = -1;
var audio_obj = null;

var in_score_background_music = null, no_audio_default_bgm = null;



$(function(){
	
	no_audio_default_bgm = '/multimedia/empty.mp3';
	
	$("#controlbutton-play").click(function(){send_request("audio", {"method": "play"})});
	$("#controlbutton-pause").click(function(){send_request("audio", {"method": "pause"})});
	$("#controlbutton-stop").click(function(){send_request("audio", {"method": "stop"})});
	$("#controlbutton-toggle-music-prev").click(function(){send_request("audio", {"method": "toggle", "plus": -1})});
	$("#controlbutton-toggle-music-next").click(function(){send_request("audio", {"method": "toggle", "plus":  1})});

	$("#controlbutton-toggle-background-prev").click(function(){send_request("screen", {"method": "toggle", "pageplus": -1})});
	$("#controlbutton-toggle-background-next").click(function(){send_request("screen", {"method": "toggle", "pageplus": 1})});
	$("#controlbutton-score").click(function(){send_request("screen", "score")});
	$("#controlbutton-background").click(function(){send_request("screen", "background")});
	$("#controlbutton-prev").click(function(){to_program(-1, true);});
	$("#controlbutton-next").click(function(){to_program(+1, true);});
	$("#controlbutton-init").click(function(){send_request("page", "init");socket.emit('global', {"need": "data"});to_program(0, true);});
	$("#controlbutton-postjavascript").click(function(){send_request("page", {"type": "run_javascript", "code": $("#text-javascript").val()})});
	$("#controlselect-changeprogram").change(function(){to_program($(this).val() - program_id, true)});
	$("#controlselect-changebgm").change(function(){send_request("audio", {"method": "toggle", "to": $(this).val()})});

	
	audio_obj = document.getElementById("dom-audio-test");
	audio_obj.autoplay = true;
	audio_obj.addEventListener("durationchange", function(e){
		$(".dom-playing-bgmcheck").html(audio_obj.duration);
	});
	
	socket = io.connect(location.origin);
	socket.on('error', function (err) {
		if (err && (err.code == 'ECONNREFUSED' || err.indexOf && err.indexOf('ECONNREFUSED') >= 0)) {
			var reconnecting = setTimeout(function () {
				socket.reconnect();
			}, 500); //assume a little threshold
			socket.on('connect', function () {
				clearTimeout(reconnecting);
				socket.removeListener('connect', arguments.callee);
			});
		}
	});
	socket.on('result', function(data){
		var id = data.data_id;
		if(id > 0 && queue.data[id]){
			console.log('Request ' + id + ' finished!');
			queue.callback[id]();
			delete queue.data[id];
			delete queue.callback[id];
		}
	});
	socket.on('whoami', function(){
		socket.emit('whoami', 'client');
		socket.emit('global', {"need": "data"});
	});
	socket.on('data', function(data){
		programs = data;
		program_id = 0;
		to_program(0, false);
		$("#controlselect-changeprogram").html(function(){
			var html = '';
			for(var i = 0; i < programs.length; i++)
			{
				html += '<option value="' + i + '">' + programs[i].program.name + '</option>';
			}
			return html;
		});
	});
	
	
	
});

var send_request = function(name, data, callback){
	if (typeof(data) == 'string') data = {'method': data};
	if (!data) data = {};
	if (typeof(callback) == "undefined") callback = function(){}
	
	queue_max++;
	queue.data[queue_max] = { name : name, data : data , id : queue_max };
	queue.callback[queue_max] = callback;
	console.log(queue.data[queue_max]);
	socket.emit(name, queue.data[queue_max]);
	
}

var to_program = function(add_number, to_client){
	
	if(program_id + add_number >= programs.length || program_id + add_number < 0)
	{
		alert("超出界限");
		return false;
	}
	
	var to_program_func = function(){
		program_id += add_number;
		program = programs[program_id];
		init_program();
		audio_obj.volume = 0;
		audio_obj.src = ((program.bgm != '') ? program.bgm: no_audio_default_bgm);
	};
	
	if (to_client)
		send_request('screen', {"method": "skipto", "id": (program_id + add_number)}, to_program_func);
	else
		to_program_func();
}

var init_program = function(){
	
	if (typeof(program.bgm) == "string") program.bgm = [program.bgm];
	if (program.bgm[0] == '' || program.bgm.length == 0) program.bgm[0] = no_audio_default_bgm;
	
	$(".dom-playing-id").text(program.id);
	$(".dom-playing-name").text(program.program.name);
	$(".dom-playing-player").text(program.player.name);
	$(".dom-autoplay").text((function(){
		if (program.display.length > 0)
		{
			return (program.display[0].time ? "√" + (program.display[0].repeat ? "(repeat)" : "") : "×");
		}
		else
		{
			return "×"
		}
	})());
	
	$("#controlselect-changebgm").html(function(){
		var html = '';
		console.log(program);
		for(var i = 0; i < program.bgm.length; i++)
		{
			html += '<option value="' + i + '">' + program.bgm[i] + '</option>';
		}
		return html;
	});
}

</script>
</body>
</html>